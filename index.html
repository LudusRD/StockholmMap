<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>–û–±—â–∞—è –∫–∞—Ä—Ç–∞ –°—Ç–æ–∫–≥–æ–ª—å–º–∞ —Å Google –ª–æ–≥–∏–Ω–æ–º</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root{
  --bg:#ffffff;
  --panel:#fafafa;
  --text:#111;
  --muted:#666;
  --accent:#2b7cff;
  --notif-bg: rgba(50,50,50,0.9);
}
body{ margin:0; font-family:Arial, sans-serif; background:var(--bg); color:var(--text); }
#controls{ padding:10px; background:var(--panel); display:flex; gap:8px; position:relative; z-index:1000; align-items:center; }
#container{ display:flex; height:calc(100vh - 52px); }
#map{ width:70%; height:100%; }
#sidebar{ width:30%; border-left:1px solid #ddd; padding:10px; overflow-y:auto; background:var(--panel); }
.marker-item{ display:flex; flex-direction:column; gap:4px; margin-bottom:8px; font-size:14px; }
.marker-item span{ cursor:pointer; }
.emoji-picker, .name-editor { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:var(--bg); border:1px solid #ccc; padding:10px; z-index:3000; box-shadow:0 6px 18px rgba(0,0,0,0.15); border-radius:8px; }
.emoji-picker{ display:grid; grid-template-columns:repeat(6,1fr); gap:6px; }
.emoji-picker span{ font-size:22px; cursor:pointer; text-align:center; padding:6px; border-radius:6px; user-select:none; }
.name-editor{ display:flex; flex-direction:column; gap:8px; min-width:260px; }
.suggestions{ position:absolute; top:46px; left:10px; right:170px; background:var(--bg); border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:2000; }
.suggestion{ padding:6px; cursor:pointer; }
.suggestion:hover{ background:#eee; }
.hidden{ display:none; }
button{ cursor:pointer; padding:6px 8px; border-radius:6px; border:1px solid #ccc; background:white; }
button.primary{ background:var(--accent); color:white; border-color:transparent; }
#authPanel{ display:flex; gap:8px; align-items:center; margin-bottom:6px; padding:8px; background:var(--panel); border-bottom:1px solid #eee; }
#roleInfo{ font-size:13px; color:var(--muted); margin-left:8px; }
.controls-input{ flex:1; padding:6px; border-radius:6px; border:1px solid #ccc; }

/* notifications left-bottom */
#notifications{ position:fixed; bottom:12px; left:12px; max-width:300px; display:flex; flex-direction:column; gap:8px; z-index:5000; }
.notification{ background:var(--notif-bg); color:white; padding:8px 12px; border-radius:8px; font-size:13px; opacity:0.98; }

/* small responsive */
@media (max-width:900px){
  #map{ width:100%; height:60vh; }
  #sidebar{ width:100%; height:40vh; border-left:none; border-top:1px solid #ddd; }
  #container{ flex-direction:column; height:calc(100vh - 104px); }
}

/* dark theme */
body.dark{
  --bg:#0f1113;
  --panel:#0b0c0d;
  --text:#e6edf3;
  --muted:#9aa5b1;
  --accent:#4ea3ff;
  --notif-bg: rgba(20,20,20,0.95);
}
</style>
</head>
<body>
<div id="authPanel">
  <button id="loginGoogleBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
  <button id="logoutBtn" class="hidden">–í—ã–π—Ç–∏</button>
  <span id="userInfo"></span>
  <span id="roleInfo"></span>
  <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
    <button id="themeToggleBtn">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
  </div>
</div>

<div id="controls">
  <input id="address" class="controls-input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å">
  <button id="searchBtn">–ù–∞–π—Ç–∏</button>
  <button id="addBtn" class="primary">–î–æ–±–∞–≤–∏—Ç—å</button>
  <div id="suggestions" class="suggestions hidden"></div>
</div>

<div id="container">
  <div id="map"></div>
  <div id="sidebar">
    <strong>–ú–µ—Ç–∫–∏</strong>
    <div id="markerList"></div>
  </div>
</div>

<!-- picker –∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
<div id="emojiPicker" class="emoji-picker hidden" aria-hidden="true"></div>

<div id="nameEditor" class="name-editor hidden" aria-hidden="true">
  <label>–ù–∞–∑–≤–∞–Ω–∏–µ
    <input id="nameInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" style="padding:6px; border-radius:6px; border:1px solid #ccc;">
  </label>
  <label>–ê–¥—Ä–µ—Å
    <input id="addrEditInput" type="text" placeholder="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å" style="padding:6px; border-radius:6px; border:1px solid #ccc;">
  </label>
  <div style="display:flex; gap:8px; justify-content:flex-end;">
    <button id="cancelNameBtn">–û—Ç–º–µ–Ω–∞</button>
    <button id="saveNameBtn" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<div id="notifications"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ====== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ======
const ALLOWED_EDITORS = [
  'some.cool.mail@gmail.com',
  'marcenuksasa32@gmail.com'
];

// ====== Firebase –∫–æ–Ω—Ñ–∏–≥ ======
const firebaseConfig = {
  apiKey: "AIzaSyAqFaNbBW-28tZ9ZOobC1mQvuAI_NWu9ms",
  authDomain: "stockholmsmap.firebaseapp.com",
  databaseURL: "https://stockholmsmap-default-rtdb.firebaseio.com",
  projectId: "stockholmsmap",
  storageBucket: "stockholmsmap.firebasestorage.app",
  messagingSenderId: "893591145593",
  appId: "1:893591145593:web:1efcdbf16243ee8171d8a8",
  measurementId: ""
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// ====== DOM ======
const loginGoogleBtn = document.getElementById('loginGoogleBtn');
const logoutBtn = document.getElementById('logoutBtn');
const userInfo = document.getElementById('userInfo');
const roleInfo = document.getElementById('roleInfo');
const addressInput = document.getElementById('address');
const suggestions = document.getElementById('suggestions');
const searchBtn = document.getElementById('searchBtn');
const addBtn = document.getElementById('addBtn');
const markerList = document.getElementById('markerList');
const emojiPicker = document.getElementById('emojiPicker');
const nameEditor = document.getElementById('nameEditor');
const nameInput = document.getElementById('nameInput');
const addrEditInput = document.getElementById('addrEditInput');
const saveNameBtn = document.getElementById('saveNameBtn');
const cancelNameBtn = document.getElementById('cancelNameBtn');
const notifications = document.getElementById('notifications');
const themeToggleBtn = document.getElementById('themeToggleBtn');

// ====== –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ======
function notify(msg, timeout = 4000){
  const div = document.createElement('div');
  div.className = 'notification';
  div.textContent = msg;
  notifications.appendChild(div);
  setTimeout(()=> {
    if(div.parentNode) div.parentNode.removeChild(div);
  }, timeout);
}

// ====== Auth provider ======
const provider = new firebase.auth.GoogleAuthProvider();

// ====== –ö–∞—Ä—Ç–∞ ======
let markers = []; // {id, marker, data}
let emojiEditTarget = null;
let nameEditTarget = null;
const EMOJIS = ['üìç','üè†','üè¢','üè™','‚òï','üçΩÔ∏è','üõí','üè•','üè´','üöá','üöå','üö≤','üéâ','‚≠ê','‚ù§Ô∏è','üî•'];

const map = L.map('map').setView([59.3293,18.0686],12);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM'});
const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© ESRI'});
osm.addTo(map);
L.control.layers({'OSM':osm,'–°–ø—É—Ç–Ω–∏–∫':satellite}).addTo(map);

function createIcon(emoji){
  return L.divIcon({className:'emoji-marker', html:`<div style="font-size:24px">${emoji}</div>`, iconSize:[28,28], iconAnchor:[14,28]});
}

function canEdit(){
  const u = auth.currentUser;
  return u && ALLOWED_EDITORS.includes(u.email);
}

function updateRoleInfo(){
  const u = auth.currentUser;
  if(!u){
    roleInfo.textContent = ' - –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç—ã';
    logoutBtn.classList.add('hidden');
    loginGoogleBtn.classList.remove('hidden');
  } else {
    const allowed = ALLOWED_EDITORS.includes(u.email);
    roleInfo.textContent = allowed ? ' - –≤—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É' : ' - –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
    logoutBtn.classList.remove('hidden');
    loginGoogleBtn.classList.add('hidden');
  }
}

// ====== –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ ======
function renderList(){
  markerList.innerHTML = '';
  markers.forEach(m => {
    const div = document.createElement('div');
    div.className = 'marker-item';
    const span = document.createElement('span');
    span.innerHTML = `${m.data.label || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}<br><small style="color:var(--muted)">${m.data.address||''}</small>`;
    span.onclick = () => map.setView([m.data.lat,m.data.lng],16);
    const controls = document.createElement('div');
    controls.style.display = 'flex';
    controls.style.gap = '6px';
    controls.style.marginTop = '6px';

    const editBtn = document.createElement('button');
    editBtn.textContent = '‚úé';
    editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ/–∞–¥—Ä–µ—Å';
    editBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É'); return; }
      openNameEditor(m.id);
    });

    const emojiBtn = document.createElement('button');
    emojiBtn.textContent = 'üòÄ';
    emojiBtn.title = '–í—ã–±—Ä–∞—Ç—å —ç–º–æ–¥–∑–∏';
    emojiBtn.className = 'emoji-open-btn';
    emojiBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É'); return; }
      openEmojiPicker(m.id);
    });

    const delBtn = document.createElement('button');
    delBtn.textContent = '‚úï';
    delBtn.title = '–£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É';
    delBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ —É–¥–∞–ª—è—Ç—å –º–µ—Ç–∫–∏'); return; }
      removeMarker(m.id);
    });

    controls.append(editBtn, emojiBtn, delBtn);
    div.append(span, controls);
    markerList.appendChild(div);
  });
}

// ====== Firebase CRUD ======
function addMarkerToFirebase(data){
  const newRef = db.ref('markers').push();
  data.id = newRef.key;
  newRef.set(data);
}

function removeMarker(id){
  db.ref('markers/'+id).remove();
  notify('–ú–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
}
function updateMarker(id,data){
  db.ref('markers/'+id).update(data);
  notify('–ú–µ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
}

// ====== Emoji picker ======
function openEmojiPicker(id){
  emojiEditTarget = markers.find(m => m.id===id);
  if(!emojiEditTarget) return;
  emojiPicker.classList.remove('hidden');
  emojiPicker.setAttribute('aria-hidden','false');
}
function renderEmojiPicker(){
  emojiPicker.innerHTML = '';
  EMOJIS.forEach(e => {
    const span = document.createElement('span');
    span.textContent = e;
    span.title = e;
    span.addEventListener('click', async (evt) => {
      evt.stopPropagation();
      if(!emojiEditTarget){ emojiPicker.classList.add('hidden'); emojiPicker.setAttribute('aria-hidden','true'); return; }
      if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É'); emojiPicker.classList.add('hidden'); emojiPicker.setAttribute('aria-hidden','true'); return; }
      emojiEditTarget.data.emoji = e;
      emojiEditTarget.marker.setIcon(createIcon(e));
      await updateMarker(emojiEditTarget.id,{emoji:e});
      emojiPicker.classList.add('hidden');
      emojiPicker.setAttribute('aria-hidden','true');
      renderList();
    });
    emojiPicker.appendChild(span);
  });
}

// –ó–∞–∫—Ä—ã–≤–∞—Ç—å emojiPicker –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
document.addEventListener('click', (e) => {
  const target = e.target;
  // –µ—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –≤–Ω—É—Ç—Ä–∏ picker –∏ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ –æ—Ç–∫—Ä—ã—Ç–∏—è —ç–º–æ–¥–∑–∏ - –∑–∞–∫—Ä—ã—Ç—å
  if(!emojiPicker.contains(target) && !target.closest('.emoji-open-btn')){
    if(!emojiPicker.classList.contains('hidden')){
      emojiPicker.classList.add('hidden');
      emojiPicker.setAttribute('aria-hidden','true');
    }
  }
});
// –ó–∞–∫—Ä—ã—Ç—å –ø–æ Esc
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape'){
    emojiPicker.classList.add('hidden');
    emojiPicker.setAttribute('aria-hidden','true');
    nameEditor.classList.add('hidden');
    nameEditor.setAttribute('aria-hidden','true');
  }
});

// ====== Name & Address editor ======
function openNameEditor(id){
  nameEditTarget = markers.find(m => m.id===id);
  if(!nameEditTarget) return;
  nameInput.value = nameEditTarget.data.label || '';
  addrEditInput.value = nameEditTarget.data.address || '';
  nameEditor.classList.remove('hidden');
  nameEditor.setAttribute('aria-hidden','false');
  nameInput.focus();
}
cancelNameBtn.addEventListener('click', () => {
  nameEditor.classList.add('hidden');
  nameEditor.setAttribute('aria-hidden','true');
  nameEditTarget = null;
});
saveNameBtn.addEventListener('click', async () => {
  if(!nameEditTarget) return;
  if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É'); nameEditor.classList.add('hidden'); nameEditTarget=null; return; }

  const newLabel = nameInput.value.trim();
  const newAddr = addrEditInput.value.trim();

  let newLat = nameEditTarget.data.lat;
  let newLng = nameEditTarget.data.lng;
  let finalAddr = newAddr;

  // –µ—Å–ª–∏ –∞–¥—Ä–µ—Å –ø–æ–º–µ–Ω—è–ª—Å—è, –¥–µ–ª–∞–µ–º –≥–µ–æ–∫–æ–¥–∏–Ω–≥
  if(newAddr && newAddr !== nameEditTarget.data.address){
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(newAddr)}`);
      const data = await res.json();
      if(data && data.length){
        newLat = +data[0].lat;
        newLng = +data[0].lon;
        finalAddr = data[0].display_name;
        // –ø–µ—Ä–µ–º–µ—â–∞–µ–º –º–∞—Ä–∫–µ—Ä
        nameEditTarget.marker.setLatLng([newLat,newLng]);
        map.setView([newLat,newLng], map.getZoom());
      } else {
        notify('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–∑–∏—Ü–∏—è –º–µ—Ç–∫–∏ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞');
      }
    } catch(e){
      console.warn('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è', e);
      notify('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è, –ø–æ–∑–∏—Ü–∏—è –º–µ—Ç–∫–∏ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞');
    }
  }

  // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  nameEditTarget.data.label = newLabel || nameEditTarget.data.label;
  nameEditTarget.data.address = finalAddr;
  nameEditTarget.data.lat = newLat;
  nameEditTarget.data.lng = newLng;

  // –æ–±–Ω–æ–≤–ª—è–µ–º popup –∏ tooltip
  nameEditTarget.marker.bindPopup(nameEditTarget.data.label || '');
  nameEditTarget.marker.setTooltipContent(`${nameEditTarget.data.label || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}<br>${nameEditTarget.data.address || ''}`);

  // –æ–±–Ω–æ–≤–ª—è–µ–º Firebase
  await updateMarker(nameEditTarget.id, {
    label: nameEditTarget.data.label,
    address: nameEditTarget.data.address,
    lat: newLat,
    lng: newLng
  });

  renderList();
  nameEditor.classList.add('hidden');
  nameEditor.setAttribute('aria-hidden','true');
  nameEditTarget = null;

  notify('–ú–µ—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
});


// ====== Reverse geocode ======
async function fetchAddress(lat, lon){
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&zoom=18&addressdetails=0&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`);
    const json = await res.json();
    if(json && json.display_name) return json.display_name;
  } catch(e){ console.warn('reverse geocode error', e); }
  return '';
}

// ====== –õ–æ–∫–∞–ª—å–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏ ======
function addMarkerLocally(id, lat, lng, label, address, emoji, uid){
  const marker = L.marker([lat,lng], { icon: createIcon(emoji || 'üìç') }).addTo(map);
  marker.bindPopup(label || '');
  const tooltip = `${label || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}${address ? '<br>' + address : ''}`;
  marker.bindTooltip(tooltip, { direction:'top', offset:[0,-10], opacity:0.95 });

  marker.on('mouseover', async () => {
    // –µ—Å–ª–∏ –Ω–µ—Ç –∞–¥—Ä–µ—Å–∞ - –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å
    const local = markers.find(x => x.id === id);
    if(local && !local.data.address){
      const addr = await fetchAddress(lat,lng);
      if(addr){
        local.data.address = addr;
        marker.setTooltipContent(`${local.data.label || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}<br>${addr}`);
        updateMarker(id,{address:addr});
        renderList();
      }
    }
    marker.openTooltip();
  });
  marker.on('mouseout', ()=> marker.closeTooltip());
  marker.on('click', ()=> marker.openPopup());

  markers.push({ id, marker, data:{ lat, lng, label, address, emoji, uid } });
  renderList();
}

// ====== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä ======
function addMarker(lat,lng,label,address){
  const user = auth.currentUser;
  if(!user){ notify('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
  if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ –¥–æ–±–∞–≤–ª—è—Ç—å –º–µ—Ç–∫–∏'); return; }
  const data = { lat, lng, label, emoji:'üìç', address, uid:user.uid, createdBy:user.email };
  addMarkerToFirebase(data);
  notify(`–ú–µ—Ç–∫–∞ "${label}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`);
}

// ====== –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ) ======
map.on('click', e => {
  const user = auth.currentUser;
  if(!user){ notify('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
  if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ –¥–æ–±–∞–≤–ª—è—Ç—å –º–µ—Ç–∫–∏'); return; }
  const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–∫–∏? (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å)');
  fetchAddress(e.latlng.lat, e.latlng.lng).then(addr => {
    const label = name ? name.trim() : (addr || '–ú–µ—Ç–∫–∞');
    const address = addr || '';
    addMarker(e.latlng.lat, e.latlng.lng, label, address);
  });
});

// ====== Firebase listener ======
db.ref('markers').on('value', async snapshot => {
  markers.forEach(m => map.removeLayer(m.marker));
  markers = [];
  snapshot.forEach(child => {
    const d = child.val();
    const id = child.key;
    addMarkerLocally(id, d.lat, d.lng, d.label, d.address, d.emoji, d.uid);
  });
});

// ====== –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ (Nominatim) ======
let suggestTimer;
async function fetchSuggestions(){
  clearTimeout(suggestTimer);
  const q = addressInput.value.trim();
  if(q.length < 3) return hideSuggestions();
  suggestTimer = setTimeout(async ()=>{
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(q)}`);
      const data = await res.json();
      suggestions.innerHTML = '';
      data.forEach(d => {
        const div = document.createElement('div');
        div.className = 'suggestion';
        div.textContent = d.display_name;
        div.onclick = () => {
          addressInput.value = d.display_name;
          map.setView([+d.lat,+d.lon],16);
          hideSuggestions();
        };
        suggestions.appendChild(div);
      });
      suggestions.classList.toggle('hidden', !data.length);
    } catch(e){ console.warn('suggestions error', e); }
  }, 300);
}
function hideSuggestions(){ suggestions.classList.add('hidden'); }

searchBtn.addEventListener('click', async () => {
  const q = addressInput.value.trim();
  if(!q) return;
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
    const data = await res.json();
    if(!data.length) return notify('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    map.setView([+data[0].lat,+data[0].lon],16);
  } catch(e){ notify('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞'); }
});
addressInput.addEventListener('input', fetchSuggestions);
document.addEventListener('click', e => { if(!suggestions.contains(e.target) && e.target!==addressInput) hideSuggestions(); });

// ====== –î–æ–±–∞–≤–∏—Ç—å –ø–æ –∞–¥—Ä–µ—Å—É —Å –∑–∞–ø—Ä–æ—Å–æ–º –Ω–∞–∑–≤–∞–Ω–∏—è ======
addBtn.addEventListener('click', async () => {
  const q = addressInput.value.trim();
  if(!q) return notify('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å');
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`);
    const data = await res.json();
    if(!data.length) return notify('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    const d = data[0];
    if(!auth.currentUser){ notify('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
    if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ –¥–æ–±–∞–≤–ª—è—Ç—å –º–µ—Ç–∫–∏'); return; }
    const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–∫–∏?');
    if(!name) return notify('–ú–µ—Ç–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞, –Ω–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è');
    addMarker(+d.lat, +d.lon, name.trim(), d.display_name);
    map.setView([+d.lat,+d.lon],16);
  } catch(e){ notify('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏'); console.warn(e); }
});

// ====== –ö–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥/–≤—ã—Ö–æ–¥ ======
loginGoogleBtn.onclick = () => {
  auth.signInWithPopup(provider)
    .then(result => { const user = result.user; notify('–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω: ' + (user.displayName || user.email)); })
    .catch(error => { notify('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message); });
};
logoutBtn.onclick = () => {
  auth.signOut().then(()=> notify('–í—ã –≤—ã—à–ª–∏'));
};

// ====== –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ======
auth.onAuthStateChanged(user => {
  if(user){ userInfo.textContent = '–ü—Ä–∏–≤–µ—Ç, ' + (user.displayName || user.email); } else { userInfo.textContent = ''; }
  updateRoleInfo();
});

// ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è emoji picker ======
renderEmojiPicker();

// ====== –¢–µ–º–∞ ======
function setDark(value){
  if(value) document.body.classList.add('dark'); else document.body.classList.remove('dark');
  localStorage.setItem('map_dark_theme', value ? '1' : '0');
}
themeToggleBtn.addEventListener('click', () => {
  const isDark = document.body.classList.contains('dark');
  setDark(!isDark);
});
(function initTheme(){
  const val = localStorage.getItem('map_dark_theme');
  setDark(val === '1');
})();

</script>
</body>
</html>
