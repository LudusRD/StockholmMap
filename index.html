<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–û–±—â–∞—è –∫–∞—Ä—Ç–∞ –°—Ç–æ–∫–≥–æ–ª—å–º–∞ —Å Google –ª–æ–≥–∏–Ω–æ–º</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; font-family:Arial,sans-serif; }
#controls { padding:10px; background:#f5f5f5; display:flex; gap:8px; position:relative; z-index:1000; align-items:center; }
#container { display:flex; }
#map { width:70%; height:calc(100vh - 52px); }
#sidebar { width:30%; border-left:1px solid #ddd; padding:10px; overflow-y:auto; }
.marker-item { display:flex; flex-direction:column; gap:4px; margin-bottom:8px; font-size:14px; }
.marker-item span { cursor:pointer; }
.emoji-picker, .name-editor { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border:1px solid #ccc; padding:10px; z-index:3000; }
.emoji-picker { display:grid; grid-template-columns:repeat(6,1fr); gap:6px; }
.emoji-picker span { font-size:22px; cursor:pointer; text-align:center; }
.name-editor { display:flex; flex-direction:column; gap:6px; }
.suggestions { position:absolute; top:46px; left:10px; right:170px; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:2000; }
.suggestion { padding:6px; cursor:pointer; }
.suggestion:hover { background:#eee; }
.hidden { display:none; }
button { cursor:pointer; }
#authPanel { display:flex; gap:6px; align-items:center; margin-bottom:6px; padding:8px; background:#fafafa; border-bottom:1px solid #eee; }
#roleInfo { font-size:13px; color:#444; margin-left:8px; }
/* —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å–ª–µ–≤–∞ —Å–Ω–∏–∑—É */
#notifications { position:fixed; bottom:10px; left:10px; max-width:250px; display:flex; flex-direction:column; gap:6px; z-index:5000; }
.notification { background:rgba(50,50,50,0.9); color:white; padding:8px 12px; border-radius:6px; font-size:13px; opacity:0.95; }
</style>
</head>
<body>
<div id="authPanel">
  <button id="loginGoogleBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
  <button id="logoutBtn" class="hidden">–í—ã–π—Ç–∏</button>
  <span id="userInfo"></span>
  <span id="roleInfo"></span>
</div>

<div id="controls">
  <input id="address" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å" style="flex:1; padding:6px;">
  <button id="searchBtn">–ù–∞–π—Ç–∏</button>
  <button id="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
  <div id="suggestions" class="suggestions hidden"></div>
</div>

<div id="container">
  <div id="map"></div>
  <div id="sidebar">
    <strong>–ú–µ—Ç–∫–∏</strong>
    <div id="markerList"></div>
  </div>
</div>

<div id="emojiPicker" class="emoji-picker hidden"></div>
<div id="nameEditor" class="name-editor hidden">
  <input id="nameInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
  <button id="saveNameBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<div id="notifications"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ====== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ======
const ALLOWED_EDITORS = [
  'some.cool.mail@gmail.com',
  'marcenuksasa32@gmail.com'
];

// ====== Firebase ======
const firebaseConfig = {
  apiKey: "AIzaSyAqFaNbBW-28tZ9ZOobC1mQvuAI_NWu9ms",
  authDomain: "stockholmsmap.firebaseapp.com",
  databaseURL: "https://stockholmsmap-default-rtdb.firebaseio.com",
  projectId: "stockholmsmap",
  storageBucket: "stockholmsmap.firebasestorage.app",
  messagingSenderId: "893591145593",
  appId: "1:893591145593:web:1efcdbf16243ee8171d8a8",
  measurementId: ""
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// ====== DOM ======
const loginGoogleBtn = document.getElementById('loginGoogleBtn');
const logoutBtn = document.getElementById('logoutBtn');
const userInfo = document.getElementById('userInfo');
const roleInfo = document.getElementById('roleInfo');
const addressInput = document.getElementById('address');
const suggestions = document.getElementById('suggestions');
const searchBtn = document.getElementById('searchBtn');
const addBtn = document.getElementById('addBtn');
const markerList = document.getElementById('markerList');
const emojiPicker = document.getElementById('emojiPicker');
const nameEditor = document.getElementById('nameEditor');
const nameInput = document.getElementById('nameInput');
const saveNameBtn = document.getElementById('saveNameBtn');
const notifications = document.getElementById('notifications');

// ====== –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ======
function notify(msg){
  const div = document.createElement('div');
  div.className = 'notification';
  div.textContent = msg;
  notifications.appendChild(div);
  setTimeout(()=> div.remove(),4000);
}

// ====== Auth provider ======
const provider = new firebase.auth.GoogleAuthProvider();

// ====== –ö–∞—Ä—Ç–∞ ======
let markers = [];
let emojiEditTarget = null;
let nameEditTarget = null;
const EMOJIS = ['üìç','üè†','üè¢','üè™','‚òï','üçΩÔ∏è','üõí','üè•','üè´','üöá','üöå','üö≤','üéâ','‚≠ê','‚ù§Ô∏è','üî•'];

const map = L.map('map').setView([59.3293,18.0686],12);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM'});
const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© ESRI'});
osm.addTo(map);
L.control.layers({'OSM':osm,'–°–ø—É—Ç–Ω–∏–∫':satellite}).addTo(map);

function createIcon(emoji){
  return L.divIcon({className:'emoji-marker',html:`<div style="font-size:24px">${emoji}</div>`,iconSize:[24,24],iconAnchor:[12,24]});
}

function canEdit(){
  const u = auth.currentUser;
  return u && ALLOWED_EDITORS.includes(u.email);
}

function updateRoleInfo(){
  const u = auth.currentUser;
  if(!u){ roleInfo.textContent = ' - –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç—ã'; logoutBtn.classList.add('hidden'); loginGoogleBtn.classList.remove('hidden'); }
  else {
    const allowed = ALLOWED_EDITORS.includes(u.email);
    roleInfo.textContent = allowed ? ' - –≤—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É' : ' - –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
    logoutBtn.classList.remove('hidden');
    loginGoogleBtn.classList.add('hidden');
  }
}

// ====== –°–ø–∏—Å–æ–∫ ======
function renderList(){
  markerList.innerHTML = '';
  markers.forEach(m => {
    const div = document.createElement('div');
    div.className = 'marker-item';
    const span = document.createElement('span');
    span.innerHTML = `${m.data.label || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}<br><small>${m.data.address||''}</small>`;
    span.onclick = () => map.setView([m.data.lat,m.data.lng],16);
    const editBtn = document.createElement('button'); editBtn.textContent = '‚úé'; editBtn.onclick = () => {
      if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É'); return; }
      openNameEditor(m.id);
    };
    const emojiBtn = document.createElement('button'); emojiBtn.textContent = 'üòÄ'; emojiBtn.onclick = () => {
      if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É'); return; }
      openEmojiPicker(m.id);
    };
    const delBtn = document.createElement('button'); delBtn.textContent = '‚úï'; delBtn.onclick = () => {
      if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ —É–¥–∞–ª—è—Ç—å –º–µ—Ç–∫–∏'); return; }
      removeMarker(m.id);
    };
    div.append(span,editBtn,emojiBtn,delBtn);
    markerList.appendChild(div);
  });
}

// ====== Firebase CRUD ======
function addMarkerToFirebase(data){
  const newRef = db.ref('markers').push();
  data.id = newRef.key;
  newRef.set(data);
}

function removeMarker(id){
  db.ref('markers/'+id).remove();
}
function updateMarker(id,data){
  db.ref('markers/'+id).update(data);
}

// ====== Emoji / name editor ======
function openEmojiPicker(id){
  emojiEditTarget = markers.find(m => m.id===id);
  if(!emojiEditTarget) return;
  emojiPicker.classList.remove('hidden');
}
function renderEmojiPicker(){
  emojiPicker.innerHTML = '';
  EMOJIS.forEach(e => {
    const span = document.createElement('span');
    span.textContent = e;
    span.onclick = () => {
      if(!emojiEditTarget){ emojiPicker.classList.add('hidden'); return; }
      if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É'); emojiPicker.classList.add('hidden'); return; }
      emojiEditTarget.data.emoji = e;
      emojiEditTarget.marker.setIcon(createIcon(e));
      updateMarker(emojiEditTarget.id,{emoji:e});
      emojiPicker.classList.add('hidden');
      renderList();
    };
    emojiPicker.appendChild(span);
  });
}
function openNameEditor(id){
  nameEditTarget = markers.find(m => m.id===id);
  if(!nameEditTarget) return;
  nameInput.value = nameEditTarget.data.label || '';
  nameEditor.classList.remove('hidden');
  nameInput.focus();
}
saveNameBtn.onclick = () => {
  if(!nameEditTarget) return;
  if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É'); nameEditor.classList.add('hidden'); return; }
  nameEditTarget.data.label = nameInput.value.trim() || nameEditTarget.data.label;
  nameEditTarget.marker.setPopupContent(nameEditTarget.data.label || '');
  updateMarker(nameEditTarget.id,{label:nameEditTarget.data.label});
  renderList();
  nameEditor.classList.add('hidden');
  nameEditTarget = null;
};

// ====== Reverse geocode ======
async function fetchAddress(lat, lon){
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&zoom=18&addressdetails=0&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`);
    const json = await res.json();
    if(json && json.display_name) return json.display_name;
  } catch(e){ console.warn('reverse geocode error', e); }
  return '';
}

// ====== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –ª–æ–∫–∞–ª—å–Ω–æ ======
function addMarkerLocally(id, lat, lng, label, address, emoji, uid){
  const marker = L.marker([lat,lng],{icon:createIcon(emoji||'üìç')}).addTo(map);
  marker.bindPopup(label || '');
  marker.bindTooltip(`${label || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}${address ? '<br>' + address : ''}`, {direction:'top', offset:[0,-10], opacity:0.95});
  marker.on('mouseover', async () => {
    const local = markers.find(x => x.id === id);
    if(local && !local.data.address){
      const addr = await fetchAddress(lat,lng);
      if(addr){
        local.data.address = addr;
        marker.setTooltipContent(`${local.data.label || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}<br>${addr}`);
        updateMarker(id,{address:addr});
        renderList();
      }
    }
    marker.openTooltip();
  });
  marker.on('mouseout', ()=> marker.closeTooltip());
  marker.on('click', ()=> marker.openPopup());
  markers.push({id, marker, data:{lat, lng, label, address, emoji, uid}});
  renderList();
}

// ====== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º ======
function addMarker(lat,lng,label,address){
  const user = auth.currentUser;
  if(!user){ notify('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
  if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ –¥–æ–±–∞–≤–ª—è—Ç—å –º–µ—Ç–∫–∏'); return; }
  const data = {lat, lng, label, emoji:'üìç', address, uid:user.uid, createdBy:user.email};
  addMarkerToFirebase(data);
  notify(`–ú–µ—Ç–∫–∞ "${label}" –¥–æ–±–∞–≤–ª–µ–Ω–∞`);
}

// ====== –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ ======
map.on('click', e => {
  const user = auth.currentUser;
  if(!user){ notify('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
  if(!canEdit()){ notify('–ù–µ—Ç –ø—Ä–∞–≤ –¥–æ–±–∞–≤–ª—è—Ç—å –º–µ—Ç–∫–∏'); return; }
  const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–∫–∏? (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å)');
  fetchAddress(e.latlng.lat, e.latlng.lng).then(addr => {
    const label = name ? name.trim() : (addr || '–ú–µ—Ç–∫–∞');
    const address = addr || '';
    addMarker(e.latlng.lat, e.latlng.lng, label, address);
  });
});

// ====== Firebase listener ======
db.ref('markers').on('value', async snapshot => {
  markers.forEach(m=> map.removeLayer(m.marker));
  markers = [];
  const promises = [];
  snapshot.forEach(child => {
    const d = child.val(); const id = child.key;
    addMarkerLocally(id, d.lat, d.lng, d.label, d.address, d.emoji, d.uid);
  });
});

// ====== –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ ======
let suggestTimer;
async function fetchSuggestions(){
  clearTimeout(suggestTimer);
  const q = addressInput.value.trim();
  if(q.length < 3) return hideSuggestions();
  suggestTimer = setTimeout(async ()=>{
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(q)}`);
      const data = await res.json();
      suggestions.innerHTML = '';
      data.forEach(d => {
        const div = document.createElement('div');
        div.className = 'suggestion';
        div.textContent = d.display_name;
        div.onclick = () => {
          addressInput.value = d.display_name;
          map.setView([+d.lat,+d.lon],16);
          hideSuggestions();
        };
        suggestions.appendChild(div);
      });
      suggestions.classList.toggle('hidden', !data.length);
    } catch(e){ console.warn('suggestions error', e); }
  }, 300);
}
function hideSuggestions(){ suggestions.classList.add('hidden'); }
searchBtn.addEventListener('click', async () => {
  const q = addressInput.value.trim();
  if(!q) return;
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
    const data = await res.json();
    if(!data.length) return notify('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    map.setView([+data[0].lat,+data[0].lon],16);
  } catch(e){ notify('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞'); }
});
addressInput.addEventListener('input', fetchSuggestions);
document.addEventListener('click', e => { if(!suggestions.contains(e.target) && e.target!==addressInput) hideSuggestions(); });

// ====== –î–æ–±–∞–≤–∏—Ç—å –ø–æ –∞–¥—Ä–µ—Å—É —Å –∑–∞–ø—Ä–æ—Å–æ–º –Ω–∞–∑–≤–∞–Ω–∏—è ======
addBtn.addEventListener('click', async () => {
  const q = addressInput.value.trim();
  if(!q) return notify('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å');
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`);
    const data = await res.json();
    if(!data.length) return notify('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    const d = data[0];
    const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–∫–∏?'); 
    if(!name) return notify('–ú–µ—Ç–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞, –Ω–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è');
    addMarker(+d.lat, +d.lon, name.trim(), d.display_name);
    map.setView([+d.lat,+d.lon],16);
  } catch(e){ notify('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏'); console.warn(e); }
});

// ====== –ö–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥/–≤—ã—Ö–æ–¥ ======
loginGoogleBtn.onclick = () => {
  auth.signInWithPopup(provider)
    .then(result => { const user = result.user; notify('–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω: ' + (user.displayName || user.email)); })
    .catch(error => { notify('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message); });
};
logoutBtn.onclick = () => { auth.signOut().then(()=> notify('–í—ã –≤—ã—à–ª–∏')); };

// ====== Auth state ======
auth.onAuthStateChanged(user => {
  if(user){ userInfo.textContent = '–ü—Ä–∏–≤–µ—Ç, ' + (user.displayName || user.email); } 
  else { userInfo.textContent = ''; }
  updateRoleInfo();
});

// ====== Emoji picker ======
renderEmojiPicker();
</script>
</body>
</html>
