<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–û–±—â–∞—è –∫–∞—Ä—Ç–∞ –°—Ç–æ–∫–≥–æ–ª—å–º–∞ —Å Google –ª–æ–≥–∏–Ω–æ–º</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; font-family:Arial,sans-serif; }
#controls { padding:10px; background:#f5f5f5; display:flex; gap:8px; position:relative; z-index:1000; align-items:center; }
#container { display:flex; }
#map { width:70%; height:calc(100vh - 52px); }
#sidebar { width:30%; border-left:1px solid #ddd; padding:10px; overflow-y:auto; }
.marker-item { display:flex; flex-direction:column; gap:4px; margin-bottom:8px; font-size:14px; }
.marker-item span { cursor:pointer; }
.emoji-picker, .name-editor { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; border:1px solid #ccc; padding:10px; z-index:3000; }
.emoji-picker { display:grid; grid-template-columns:repeat(6,1fr); gap:6px; }
.emoji-picker span { font-size:22px; cursor:pointer; text-align:center; }
.name-editor { display:flex; flex-direction:column; gap:6px; }
.suggestions { position:absolute; top:46px; left:10px; right:170px; background:white; border:1px solid #ccc; max-height:200px; overflow-y:auto; z-index:2000; }
.suggestion { padding:6px; cursor:pointer; }
.suggestion:hover { background:#eee; }
.hidden { display:none; }
button { cursor:pointer; }
#authPanel { display:flex; gap:6px; align-items:center; margin-bottom:6px; padding:8px; background:#fafafa; border-bottom:1px solid #eee; }
#roleInfo { font-size:13px; color:#444; margin-left:8px; }
</style>
</head>
<body>
<div id="authPanel">
  <button id="loginGoogleBtn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
  <button id="logoutBtn" class="hidden">–í—ã–π—Ç–∏</button>
  <span id="userInfo"></span>
  <span id="roleInfo"></span>
</div>

<div id="controls">
  <input id="address" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å" style="flex:1; padding:6px;">
  <button id="searchBtn">–ù–∞–π—Ç–∏</button>
  <button id="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
  <div id="suggestions" class="suggestions hidden"></div>
</div>

<div id="container">
  <div id="map"></div>
  <div id="sidebar">
    <strong>–ú–µ—Ç–∫–∏</strong>
    <div id="markerList"></div>
  </div>
</div>

<div id="emojiPicker" class="emoji-picker hidden"></div>
<div id="nameEditor" class="name-editor hidden">
  <input id="nameInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ">
  <button id="saveNameBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
// ====== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ======
// –°–ø–∏—Å–æ–∫ Google-–ø–æ—á—Ç, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç –ø—Ä–∞–≤–æ –º–µ–Ω—è—Ç—å –∫–∞—Ä—Ç—É
const ALLOWED_EDITORS = [
  'some.cool.mail@gmail.com',
  'marcenuksasa32@gmail.com'
  // –¥–æ–±–∞–≤—å —Å—é–¥–∞ –Ω—É–∂–Ω—ã–µ –ø–æ—á—Ç—ã
];

// ====== Firebase –∫–æ–Ω—Ñ–∏–≥ ======
const firebaseConfig = {
  apiKey: "AIzaSyAqFaNbBW-28tZ9ZOobC1mQvuAI_NWu9ms",
  authDomain: "stockholmsmap.firebaseapp.com",
  databaseURL: "https://stockholmsmap-default-rtdb.firebaseio.com",
  projectId: "stockholmsmap",
  storageBucket: "stockholmsmap.firebasestorage.app",
  messagingSenderId: "893591145593",
  appId: "1:893591145593:web:1efcdbf16243ee8171d8a8",
  measurementId: ""
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// ====== DOM —ç–ª–µ–º–µ–Ω—Ç—ã ======
const loginGoogleBtn = document.getElementById('loginGoogleBtn');
const logoutBtn = document.getElementById('logoutBtn');
const userInfo = document.getElementById('userInfo');
const roleInfo = document.getElementById('roleInfo');
const addressInput = document.getElementById('address');
const suggestions = document.getElementById('suggestions');
const searchBtn = document.getElementById('searchBtn');
const addBtn = document.getElementById('addBtn');
const markerList = document.getElementById('markerList');
const emojiPicker = document.getElementById('emojiPicker');
const nameEditor = document.getElementById('nameEditor');
const nameInput = document.getElementById('nameInput');
const saveNameBtn = document.getElementById('saveNameBtn');

// ====== Auth provider ======
const provider = new firebase.auth.GoogleAuthProvider();

// ====== –ö–∞—Ä—Ç–∞ –∏ –¥–∞–Ω–Ω—ã–µ ======
let markers = []; // [{id, marker, data}]
let emojiEditTarget = null;
let nameEditTarget = null;
const EMOJIS = ['üìç','üè†','üè¢','üè™','‚òï','üçΩÔ∏è','üõí','üè•','üè´','üöá','üöå','üö≤','üéâ','‚≠ê','‚ù§Ô∏è','üî•'];

const map = L.map('map').setView([59.3293,18.0686],12);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OSM'});
const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'¬© ESRI'});
osm.addTo(map);
L.control.layers({'OSM':osm,'–°–ø—É—Ç–Ω–∏–∫':satellite}).addTo(map);

function createIcon(emoji){
  return L.divIcon({className:'emoji-marker',html:`<div style="font-size:24px">${emoji}</div>`,iconSize:[24,24],iconAnchor:[12,24]});
}

function canEdit(){
  const u = auth.currentUser;
  return u && ALLOWED_EDITORS.includes(u.email);
}

function updateRoleInfo(){
  const u = auth.currentUser;
  if(!u){ roleInfo.textContent = ' - –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç—ã'; logoutBtn.classList.add('hidden'); loginGoogleBtn.classList.remove('hidden'); }
  else {
    const allowed = ALLOWED_EDITORS.includes(u.email);
    roleInfo.textContent = allowed ? ' - –≤—ã –º–æ–∂–µ—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É' : ' - –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
    logoutBtn.classList.remove('hidden');
    loginGoogleBtn.classList.add('hidden');
  }
}

// ====== –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –º–µ—Ç–æ–∫ ======
function renderList(){
  markerList.innerHTML = '';
  markers.forEach(m => {
    const div = document.createElement('div');
    div.className = 'marker-item';
    const span = document.createElement('span');
    span.innerHTML = `${m.data.label || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}<br><small>${m.data.address||''}</small>`;
    span.onclick = () => map.setView([m.data.lat,m.data.lng],16);
    const editBtn = document.createElement('button'); editBtn.textContent = '‚úé'; editBtn.onclick = () => {
      if(!canEdit()){ alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É'); return; }
      openNameEditor(m.id);
    };
    const emojiBtn = document.createElement('button'); emojiBtn.textContent = 'üòÄ'; emojiBtn.onclick = () => {
      if(!canEdit()){ alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É'); return; }
      openEmojiPicker(m.id);
    };
    const delBtn = document.createElement('button'); delBtn.textContent = '‚úï'; delBtn.onclick = () => {
      if(!canEdit()){ alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É'); return; }
      removeMarker(m.id);
    };
    div.append(span,editBtn,emojiBtn,delBtn);
    markerList.appendChild(div);
  });
}

// ====== Firebase CRUD ======
function addMarkerToFirebase(data){
  const newRef = db.ref('markers').push();
  data.id = newRef.key;
  newRef.set(data);
}

function removeMarker(id){
  db.ref('markers/'+id).remove();
}
function updateMarker(id,data){
  db.ref('markers/'+id).update(data);
}

// ====== Emoji / name editor ======
function openEmojiPicker(id){
  emojiEditTarget = markers.find(m => m.id===id);
  if(!emojiEditTarget) return;
  emojiPicker.classList.remove('hidden');
}
function renderEmojiPicker(){
  emojiPicker.innerHTML = '';
  EMOJIS.forEach(e => {
    const span = document.createElement('span');
    span.textContent = e;
    span.onclick = () => {
      if(!emojiEditTarget){ emojiPicker.classList.add('hidden'); return; }
      // –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ —Å–ª—É—á–∞–π –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ UI
      if(!canEdit()){ alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É'); emojiPicker.classList.add('hidden'); return; }
      emojiEditTarget.data.emoji = e;
      emojiEditTarget.marker.setIcon(createIcon(e));
      updateMarker(emojiEditTarget.id,{emoji:e});
      emojiPicker.classList.add('hidden');
      renderList();
    };
    emojiPicker.appendChild(span);
  });
}
function openNameEditor(id){
  nameEditTarget = markers.find(m => m.id===id);
  if(!nameEditTarget) return;
  nameInput.value = nameEditTarget.data.label || '';
  nameEditor.classList.remove('hidden');
  nameInput.focus();
}
saveNameBtn.onclick = () => {
  if(!nameEditTarget) return;
  if(!canEdit()){ alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É'); nameEditor.classList.add('hidden'); return; }
  nameEditTarget.data.label = nameInput.value.trim() || nameEditTarget.data.label;
  nameEditTarget.marker.setPopupContent(nameEditTarget.data.label || '');
  updateMarker(nameEditTarget.id,{label:nameEditTarget.data.label});
  renderList();
  nameEditor.classList.add('hidden');
  nameEditTarget = null;
};

// ====== –ü–æ–º–æ—â—å: –ø–æ–ª—É—á–∏—Ç—å –∞–¥—Ä–µ—Å —á–µ—Ä–µ–∑ reverse geocode ======
async function fetchAddress(lat, lon){
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&zoom=18&addressdetails=0&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`);
    const json = await res.json();
    if(json && json.display_name) return json.display_name;
  } catch(e){ console.warn('reverse geocode error', e); }
  return '';
}

// ====== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –Ω–∞ –∫–∞—Ä—Ç—É (–ª–æ–∫–∞–ª—å–Ω–æ) ======
function addMarkerLocallyAndMaybeFirebase(id, lat, lng, label, address, emoji, uid){
  const marker = L.marker([lat,lng],{icon:createIcon(emoji || 'üìç')}).addTo(map);
  marker.bindPopup(label || '');
  // tooltip content
  const tooltipText = `${label || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}${address ? '<br>' + address : ''}`;
  marker.bindTooltip(tooltipText, {direction:'top', offset:[0,-10], opacity:0.95});
  // show tooltip on hover
  marker.on('mouseover', async () => {
    // if no address in data, try reverse geocode once and update DB & local
    const local = markers.find(x => x.id === id);
    if(local && !local.data.address){
      const addr = await fetchAddress(lat,lng);
      if(addr){
        local.data.address = addr;
        // –æ–±–Ω–æ–≤–∏–º tooltip –∏ —Å–ø–∏—Å–æ–∫ –∏ –±–∞–∑—É
        marker.setTooltipContent(`${local.data.label || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}<br>${addr}`);
        updateMarker(id,{address:addr});
        renderList();
      }
    }
    marker.openTooltip();
  });
  marker.on('mouseout', ()=> marker.closeTooltip());
  // –∫–ª–∏–∫ - –æ—Ç–∫—Ä—ã—Ç—å –ø–æ–ø–∞–ø
  marker.on('click', ()=> marker.openPopup());
  markers.push({id, marker, data:{lat, lng, label, address, emoji, uid}});
  renderList();
}

// ====== –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤ ======
function addMarker(lat,lng,label,address){
  const user = auth.currentUser;
  if(!user){ alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
  if(!canEdit()){ alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ–±–∞–≤–ª—è—Ç—å –º–µ—Ç–∫–∏'); return; }
  const data = {lat, lng, label, emoji:'üìç', address, uid:user.uid, createdBy:user.email};
  addMarkerToFirebase(data);
}

// ====== –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ), –Ω–æ —Å –ø—Ä–∞–≤–∞–º–∏ ======
map.on('click', e => {
  const user = auth.currentUser;
  if(!user){ alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
  if(!canEdit()){ alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ–±–∞–≤–ª—è—Ç—å –º–µ—Ç–∫–∏'); return; }
  const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–∫–∏? (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–¥—Ä–µ—Å)');
  // –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –±–ª–∏–∂–∞–π—à–∏–π –∞–¥—Ä–µ—Å
  fetchAddress(e.latlng.lat, e.latlng.lng).then(addr => {
    const label = name ? name.trim() : (addr || '–ú–µ—Ç–∫–∞');
    const address = addr || '';
    const data = {lat:e.latlng.lat, lng:e.latlng.lng, label, emoji:'üìç', address, uid:user.uid, createdBy:user.email};
    addMarkerToFirebase(data);
  });
});

// ====== –°–ª—É—à–∞—Ç–µ–ª—å Firebase: –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–∞—Ä–∫–µ—Ä–æ–≤ ======
db.ref('markers').on('value', async snapshot => {
  // –æ—á–∏—Å—Ç–∫–∞
  markers.forEach(m=> map.removeLayer(m.marker));
  markers = [];
  // –ø—Ä–æ—á–∏—Ç–∞–µ–º –≤—Å–µ
  const promises = [];
  snapshot.forEach(child => {
    const d = child.val();
    const id = child.key;
    const marker = L.marker([d.lat,d.lng],{icon:createIcon(d.emoji||'üìç')}).addTo(map);
    marker.bindPopup(d.label || '');
    const tooltipText = `${d.label || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}${d.address ? '<br>' + d.address : ''}`;
    marker.bindTooltip(tooltipText, {direction:'top', offset:[0,-10], opacity:0.95});
    // hover: –µ—Å–ª–∏ –Ω–µ—Ç address, —Å–¥–µ–ª–∞–µ–º reverse –∏ –æ–±–Ω–æ–≤–∏–º
    marker.on('mouseover', async () => {
      if(!d.address){
        const addr = await fetchAddress(d.lat,d.lng);
        if(addr){
          d.address = addr;
          updateMarker(id,{address:addr});
          marker.setTooltipContent(`${d.label || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}<br>${addr}`);
          renderList();
        }
      }
      marker.openTooltip();
    });
    marker.on('mouseout', ()=> marker.closeTooltip());
    marker.on('click', ()=> marker.openPopup());
    markers.push({id, marker, data:d});
    // –µ—Å–ª–∏ –∞–¥—Ä–µ—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø–æ–ª–æ–∂–∏–º –∑–∞–¥–∞—á—É –Ω–∞ reverse –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞—Ä–∞–Ω–µ–µ (—á—Ç–æ–±—ã tooltip –±—ã–ª)
    if(!d.address){
      promises.push((async ()=>{
        const addr = await fetchAddress(d.lat,d.lng);
        if(addr){
          d.address = addr;
          // –æ–±–Ω–æ–≤–∏–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—â–µ –≤ –±–∞–∑–µ –Ω–µ—Ç –∞–¥—Ä–µ—Å–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç –≥–æ–Ω–∫–∏)
          updateMarker(id,{address:addr});
          marker.setTooltipContent(`${d.label || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}<br>${addr}`);
        }
      })());
    }
  });
  // –¥–æ–∂–¥—ë–º—Å—è –≤—Å–µ—Ö reverse –∑–∞–ø—Ä–æ—Å–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  try { await Promise.all(promises); } catch(e){/*ignore*/ }
  renderList();
});

// ====== –ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–∞ –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ (Nominatim) ======
let suggestTimer;
async function fetchSuggestions(){
  clearTimeout(suggestTimer);
  const q = addressInput.value.trim();
  if(q.length < 3) return hideSuggestions();
  suggestTimer = setTimeout(async ()=>{
    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(q)}`);
      const data = await res.json();
      suggestions.innerHTML = '';
      data.forEach(d => {
        const div = document.createElement('div');
        div.className = 'suggestion';
        div.textContent = d.display_name;
        div.onclick = () => {
          addressInput.value = d.display_name;
          map.setView([+d.lat,+d.lon],16);
          hideSuggestions();
        };
        suggestions.appendChild(div);
      });
      suggestions.classList.toggle('hidden', !data.length);
    } catch(e){ console.warn('suggestions error', e); }
  }, 300);
}
function hideSuggestions(){ suggestions.classList.add('hidden'); }

searchBtn.addEventListener('click', async () => {
  const q = addressInput.value.trim();
  if(!q) return;
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
    const data = await res.json();
    if(!data.length) return alert('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    map.setView([+data[0].lat,+data[0].lon],16);
  } catch(e){ alert('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞'); }
});

addressInput.addEventListener('input', fetchSuggestions);
document.addEventListener('click', e => { if(!suggestions.contains(e.target) && e.target!==addressInput) hideSuggestions(); });

// ====== –î–æ–±–∞–≤–∏—Ç—å –ø–æ –≤–≤–µ–¥—ë–Ω–Ω–æ–º—É –∞–¥—Ä–µ—Å—É ======
addBtn.addEventListener('click', async () => {
  const q = addressInput.value.trim();
  if(!q) return alert('–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å');
  // –∏—â–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`);
    const data = await res.json();
    if(!data.length) return alert('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    const d = data[0];
    // –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
    const user = auth.currentUser;
    if(!user){ alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ'); return; }
    if(!canEdit()){ alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–æ–±–∞–≤–ª—è—Ç—å –º–µ—Ç–∫–∏'); return; }
    // label –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - display_name
    const label = d.display_name;
    addMarker(+d.lat, +d.lon, label, d.display_name);
    // —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º
    map.setView([+d.lat, +d.lon], 16);
  } catch(e){ alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–∏'); console.warn(e); }
});

// ====== –ö–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥/–≤—ã—Ö–æ–¥ ======
loginGoogleBtn.onclick = () => {
  auth.signInWithPopup(provider)
    .then(result => {
      const user = result.user;
      alert('–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω: ' + (user.displayName || user.email));
    })
    .catch(error => {
      alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
    });
};
logoutBtn.onclick = () => {
  auth.signOut().then(()=>{ alert('–í—ã –≤—ã—à–ª–∏'); });
};

// ====== –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ======
auth.onAuthStateChanged(user => {
  if(user){
    userInfo.textContent = '–ü—Ä–∏–≤–µ—Ç, ' + (user.displayName || user.email);
  } else {
    userInfo.textContent = '';
  }
  updateRoleInfo();
});

// ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è emoji picker ======
renderEmojiPicker();
</script>
</body>
</html>
